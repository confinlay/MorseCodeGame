#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include "pico/stdlib.h"

#include "hardware/gpio.h"
#include "hardware/watchdog.h"
#include "pico/time.h"
#include "hardware/pio.h"
#include "hardware/clocks.h"
#include "ws2812.pio.h"

#define IS_RGBW true        // Will use RGBW format
#define NUM_PIXELS 1        // There is 1 WS2812 device in the chain
#define WS2812_PIN 28       // The GPIO pin that the WS2812 connected to

// Must declare the main assembly entry point before use.
void main_asm();
// Initialise a GPIO pin – see SDK for detail on gpio_init()
void asm_gpio_init(uint pin) {
 gpio_init(pin);
}
// Set direction of a GPIO pin – see SDK for detail on gpio_set_dir()
void asm_gpio_set_dir(uint pin, bool out) {
 gpio_set_dir(pin, out);
}
// Get the value of a GPIO pin – see SDK for detail on gpio_get()
bool asm_gpio_get(uint pin) {
 return gpio_get(pin);
}
// Set the value of a GPIO pin – see SDK for detail on gpio_put()
void asm_gpio_put(uint pin, bool value) {
 gpio_put(pin, value);
}

// Enable falling-edge interrupt – see SDK for detail on gpio_set_irq_enabled()
void asm_gpio_set_irq(uint pin) {
 gpio_set_irq_enabled(pin, GPIO_IRQ_EDGE_FALL, true);
}

// Enable rising-edge interrupt 
void asm_gpio_set_irq1(uint pin) {
 gpio_set_irq_enabled(pin, GPIO_IRQ_EDGE_RISE, true);
}

void welcomeMessage();

/**
 * @brief Wrapper function used to call the underlying PIO
 *        function that pushes the 32-bit RGB colour value
 *        out to the LED serially using the PIO0 block. The
 *        function does not return until all of the data has
 *        been written out.
 * 
 * @param pixel_grb The 32-bit colour value generated by urgb_u32()
 */
static inline void put_pixel(uint32_t pixel_grb) {
    pio_sm_put_blocking(pio0, 0, pixel_grb << 8u);
}

/**
 * @brief Function to generate an unsigned 32-bit composit GRB
 *        value by combining the individual 8-bit paramaters for
 *        red, green and blue together in the right order.
 * 
 * @param r     The 8-bit intensity value for the red component
 * @param g     The 8-bit intensity value for the green component
 * @param b     The 8-bit intensity value for the blue component
 * @return uint32_t Returns the resulting composit 32-bit RGB value
 */
static inline uint32_t urgb_u32(uint8_t r, uint8_t g, uint8_t b) {
    return  ((uint32_t) (r) << 8)  |
            ((uint32_t) (g) << 16) |
            (uint32_t) (b);
}


//initialise watchdog timer
void watchdog_init(){
    if(watchdog_caused_reboot){
        printf("Game Restarted due to inactivity!\n");
    }
    //enable the watchdogtimer set to the max time, approx 8.3 secs
    //One sets the watchdog timer to pause during debug 
    watchdog_enable(0x7fffff, 0); 
    watchdog_update();
}

//need to be global cuz we jump in and out of ASM
int input = 0;
int start_high = 0; // this is set to 1 after the first button release (rising edge) and should stay like this while the game is running
int start_low = 0;
int i = 0;
int first[7];
bool type = true;
uint32_t low_interval, high_interval;

void set_start_high(int i){
    start_high = i;
}

void set_start_low(int i){
    start_low = i;
}

void check_for_interrupt(int signal){
    input = signal;
}

void store_interval_low(int interval){
    low_interval = interval;
}

void store_interval_high(int interval){
    high_interval = interval;
}

//function returns the value stored in r7, hasnt been tested with interval timer yet
int32_t time_pressed();
int32_t time_space();
void reset();

// Main entry point of the application
int main() {
    stdio_init_all(); // Initialise all basic IO
    //watchdog_init(); // Initialise watchdog timer
    main_asm(); // Initialise pins and interrupt
    welcomeMessage(); // print welcome message

    uint32_t starter = 0;

    while (i < 7){
        //set timer for 2 seconds, loop until that runs out, then pass the sequence to the game
        if (input){ //if there was an interrupt
            if (type && start_high == 1){
                i++;
                first[i-1] = high_interval;
                type = false;
                input = 0;
            } else {
                if (start_low == 1){
                    i++;
                    first[i-1] = low_interval;
                    type = true;  
                    input = 0; 
                }
                 
            }
            
        }
        
    }
    printf("made it past !\n");
    printf("starter: %d", starter);
    
    while (1){

    };

    return(0);
}


// Print the welcome message
void welcomeMessage() {
    // 80 char width, pipes inclusive
    printf(".______________________________________________________________________________.\n");
    printf("|                    _____ _____   ____  _    _ _____    __                    |\n");
    printf("|    Conor          / ____|  __ \\ / __ \\| |  | |  __ \\  /_ |            Joe    |\n");
    printf("|    Finlay        | |  __| |__) | |  | | |  | | |__) |  | |        Mulvany    |\n");
    printf("|                  | | |_ |  _  /| |  | | |  | |  ___/   | |                   |\n");
    printf("|    Fionnan       | |__| | | \\ \\| |__| | |__| | |       | |        Tiernan    |\n");
    printf("|    O\'Sullivan     \\_____|_|  \\_\\\\____/ \\____/|_|       |_|         Mullen    |\n");
    printf(".______________________________________________________________________________.\n");
    printf("|         ___           ___           ___           ___           ___          |\n");
    printf("|        /\\__\\         /\\  \\         /\\  \\         /\\  \\         /\\  \\         |\n");
    printf("|       /::|  |       /::\\  \\       /::\\  \\       /::\\  \\       /::\\  \\        |\n");
    printf("|      /:|:|  |      /:/\\:\\  \\     /:/\\:\\  \\     /:/\\ \\  \\     /:/\\:\\  \\       |\n");
    printf("|     /:/|:|__|__   /:/  \\:\\  \\   /::\\~\\:\\  \\   _\\:\\~\\ \\  \\   /::\\~\\:\\  \\      |\n");
    printf("|    /:/ |::::\\__\\ /:/__/ \\:\\__\\ /:/\\:\\ \\:\\__\\ /\\ \\:\\ \\ \\__\\ /:/\\:\\ \\:\\__\\     |\n");
    printf("|    \\/__/~~/:/  / \\:\\  \\ /:/  / \\/_|::\\/:/  / \\:\\ \\:\\ \\/__/ \\:\\~\\:\\ \\/__/     |\n");
    printf("|          /:/  /   \\:\\  /:/  /     |:|::/  /   \\:\\ \\:\\__\\    \\:\\ \\:\\__\\       |\n");
    printf("|         /:/  /     \\:\\/:/  /      |:|\\/__/     \\:\\/:/  /     \\:\\ \\/__/       |\n");
    printf("|        /:/  /       \\::/  /       |:|  |        \\::/  /       \\:\\__\\         |\n");
    printf("|        \\/__/         \\/__/         \\|__|         \\/__/         \\/__/         |\n");
    printf("|               ___           ___           ___           ___                  |\n");
    printf("|              /\\  \\         /\\  \\         /\\  \\         /\\  \\                 |\n");
    printf("|             /::\\  \\       /::\\  \\       /::\\  \\       /::\\  \\                |\n");
    printf("|            /:/\\:\\  \\     /:/\\:\\  \\     /:/\\:\\  \\     /:/\\:\\  \\               |\n");
    printf("|           /:/  \\:\\  \\   /:/  \\:\\  \\   /:/  \\:\\__\\   /::\\~\\:\\  \\              |\n");
    printf("|          /:/__/ \\:\\__\\ /:/__/ \\:\\__\\ /:/__/ \\:|__| /:/\\:\\ \\:\\__\\             |\n");
    printf("|          \\:\\  \\  \\/__/ \\:\\  \\ /:/  / \\:\\  \\ /:/  / \\:\\~\\:\\ \\/__/             |\n");
    printf("|           \\:\\  \\        \\:\\  /:/  /   \\:\\  /:/  /   \\:\\ \\:\\__\\               |\n");
    printf("|            \\:\\  \\        \\:\\/:/  /     \\:\\/:/  /     \\:\\ \\/__/               |\n");
    printf("|             \\:\\__\\        \\::/  /       \\::/__/       \\:\\__\\                 |\n");
    printf("|              \\/__/         \\/__/         ~~            \\/__/                 |\n");
    printf("|               ___           ___           ___           ___                  |\n");
    printf("|              /\\  \\         /\\  \\         /\\__\\         /\\  \\                 |\n");
    printf("|             /::\\  \\       /::\\  \\       /::|  |       /::\\  \\                |\n");
    printf("|            /:/\\:\\  \\     /:/\\:\\  \\     /:|:|  |      /:/\\:\\  \\               |\n");
    printf("|           /:/  \\:\\  \\   /::\\~\\:\\  \\   /:/|:|__|__   /::\\~\\:\\  \\              |\n");
    printf("|          /:/__/_\\:\\__\\ /:/\\:\\ \\:\\__\\ /:/ |::::\\__\\ /:/\\:\\ \\:\\__\\             |\n");
    printf("|          \\:\\  /\\ \\/__/ \\/__\\:\\/:/  / \\/__/~~/:/  / \\:\\~\\:\\ \\/__/             |\n");
    printf("|           \\:\\ \\:\\__\\        \\::/  /        /:/  /   \\:\\ \\:\\__\\               |\n");
    printf("|            \\:\\/:/  /        /:/  /        /:/  /     \\:\\ \\/__/               |\n");
    printf("|             \\::/  /        /:/  /        /:/  /       \\:\\__\\                 |\n");
    printf("|              \\/__/         \\/__/         \\/__/         \\/__/                 |\n");
    printf(".______________________________________________________________________________.\n");
    printf("|                                                                              |\n");
    printf("|           Enter a sequence of dots and dashes using GP21 to begin!           |\n");
    printf("|                                                                              |\n");
    printf("|                            Level 1 : .----                                   |\n");
    printf("|                                                                              |\n");
    printf("|                                                                              |\n");
    printf(".______________________________________________________________________________.\n");
}


// Return a random character from 0-9 or A-Z when called
char randomChar() {
    // Use the current microsecond count to seed the random number generator
    uint64_t seed = time_us_64();
    srand(seed);

    // Generate a random number (0 - 9: numbers; 10 - 35: letters)
    int random_num = rand() % 35;

    // If 0 -> 9, return straight away
    // Otherwise, convert the number to an uppercase letter and return the letter
    if (random_num < 10) {
        return random_num + '0';
    } else {
        return (random_num - 10) + 'A';
    }
}
